// ===================================================================
// Template de Projeto Java Moderno com Gradle
// ===================================================================

plugins {
    id 'application'                                                        // Plugin para aplicaÃ§Ãµes executÃ¡veis
    id 'java'                                                              // Plugin base para Java
    id 'checkstyle'                                                        // AnÃ¡lise estÃ¡tica de cÃ³digo
    id 'jacoco'                                                           // Cobertura de testes
    id 'org.gradle.toolchains.foojay-resolver-convention' version '0.8.0' // Auto-provisionamento de JDKs
}

// ===================================================================
// ConfiguraÃ§Ãµes BÃ¡sicas do Projeto
// ===================================================================

group = 'com.template'
version = '1.0.0'

java {
    // ConfiguraÃ§Ã£o do Java Toolchain - garante consistÃªncia entre ambientes
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)           // Java 17 (LTS)
        vendor = JvmVendorSpec.ADOPTIUM                        // OpenJDK da Eclipse Adoptium
    }
    
    // ConfiguraÃ§Ãµes adicionais
    withSourcesJar()                                           // Gera JAR com cÃ³digo-fonte
    withJavadocJar()                                          // Gera JAR com documentaÃ§Ã£o
}

// ===================================================================
// ConfiguraÃ§Ã£o da AplicaÃ§Ã£o
// ===================================================================

application {
    mainClass = 'main.Main'                                   // Classe principal para execuÃ§Ã£o
    
    // Argumentos padrÃ£o da JVM para otimizaÃ§Ã£o
    applicationDefaultJvmArgs = [
        '-Xms64m',                                            // Heap inicial
        '-Xmx256m',                                           // Heap mÃ¡ximo
        '-Dfile.encoding=UTF-8'                               // Encoding padrÃ£o
    ]
}

// ===================================================================
// RepositÃ³rios de DependÃªncias
// ===================================================================

repositories {
    mavenCentral()                                            // RepositÃ³rio central do Maven
    gradlePluginPortal()                                      // Para plugins do Gradle
}

// ===================================================================
// DependÃªncias do Projeto
// ===================================================================

dependencies {
    // === DependÃªncias de Teste ===
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.2'              // JUnit 5
    testImplementation 'org.assertj:assertj-core:3.25.1'                     // Assertions fluentes
    testImplementation 'org.mockito:mockito-core:5.8.0'                      // Mocking framework
    testImplementation 'org.mockito:mockito-junit-jupiter:5.8.0'             // IntegraÃ§Ã£o Mockito + JUnit 5
    
    // === DependÃªncias de Runtime (exemplos para expandir o template) ===
    // implementation 'com.fasterxml.jackson.core:jackson-databind:2.16.1'   // JSON processing
    // implementation 'org.slf4j:slf4j-api:2.0.9'                           // Logging API
    // runtimeOnly 'ch.qos.logback:logback-classic:1.4.14'                  // Logging implementation
}

// ===================================================================
// ConfiguraÃ§Ã£o de Testes
// ===================================================================

test {
    useJUnitPlatform()                                        // Utiliza JUnit 5 Platform
    
    // ConfiguraÃ§Ãµes de JVM para testes
    jvmArgs = [
        '-Dfile.encoding=UTF-8',
        '-Duser.timezone=UTC'
    ]
    
    // RelatÃ³rios detalhados
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
        showStandardStreams = false
    }
    
    // Executa relatÃ³rio de cobertura apÃ³s os testes
    finalizedBy jacocoTestReport
}

// ===================================================================
// ConfiguraÃ§Ã£o do Jacoco (Cobertura de CÃ³digo)
// ===================================================================

jacoco {
    toolVersion = "0.8.11"                                   // VersÃ£o do Jacoco
}

jacocoTestReport {
    dependsOn test
    
    reports {
        xml.required = true                                   // Para integraÃ§Ã£o com CI/CD
        html.required = true                                  // Para visualizaÃ§Ã£o local
        csv.required = false                                  // Desabilitado por padrÃ£o
    }
    
    // Limites mÃ­nimos de cobertura
    doLast {
        println "RelatÃ³rio de cobertura gerado em: ${reports.html.outputLocation.get()}"
    }
}

jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = 0.70                                // MÃ­nimo de 70% de cobertura
            }
        }
    }
}

// ===================================================================
// ConfiguraÃ§Ã£o do Checkstyle (AnÃ¡lise EstÃ¡tica)
// ===================================================================

checkstyle {
    toolVersion = '10.12.7'                                  // VersÃ£o do Checkstyle
    configFile = file('config/checkstyle/checkstyle.xml')    // Arquivo de configuraÃ§Ã£o personalizado
    ignoreFailures = false                                    // Falha o build se houver violaÃ§Ãµes
    maxWarnings = 0                                          // NÃ£o permite warnings
}

checkstyleMain {
    source = 'src/main/java'
}

checkstyleTest {
    source = 'src/test/java'
}

// ===================================================================
// ConfiguraÃ§Ãµes de CompilaÃ§Ã£o
// ===================================================================

compileJava {
    options.encoding = 'UTF-8'
    options.compilerArgs += [
        '-Xlint:all',                                        // Todos os warnings
        '-Xlint:-processing',                                // Exceto processamento de anotaÃ§Ãµes
        '-Werror'                                            // Trata warnings como erros
    ]
}

compileTestJava {
    options.encoding = 'UTF-8'
    options.compilerArgs += ['-Xlint:all', '-Xlint:-processing']
}

// ===================================================================
// ConfiguraÃ§Ãµes do JAR
// ===================================================================

jar {
    archiveBaseName = rootProject.name
    archiveVersion = version
    
    manifest {
        attributes(
            'Main-Class': application.mainClass,
            'Implementation-Title': project.name,
            'Implementation-Version': project.version,
            'Implementation-Vendor': 'Template Project',
            'Built-By': System.getProperty('user.name'),
            'Built-Date': new Date().format('yyyy-MM-dd HH:mm:ss'),
            'Built-JDK': System.getProperty('java.version')
        )
    }
}

// ===================================================================
// Tarefas Personalizadas
// ===================================================================

// Tarefa para limpeza completa
tasks.register('cleanAll') {
    group = 'build'
    description = 'Limpa todos os arquivos gerados incluindo caches'
    
    doLast {
        delete fileTree('.') {
            include '**/*.log'
            include '**/*.tmp'
        }
        println 'Limpeza completa realizada!'
    }
}

// Tarefa para verificaÃ§Ã£o completa de qualidade
tasks.register('qualityCheck') {
    group = 'verification'
    description = 'Executa todas as verificaÃ§Ãµes de qualidade'
    dependsOn 'check', 'jacocoTestCoverageVerification'
    
    doLast {
        println 'Todas as verificaÃ§Ãµes de qualidade foram executadas com sucesso!'
    }
}

// ===================================================================
// ConfiguraÃ§Ãµes de Wrapper
// ===================================================================

wrapper {
    gradleVersion = '8.5'                                    // VersÃ£o especÃ­fica do Gradle
    distributionType = Wrapper.DistributionType.BIN         // DistribuiÃ§Ã£o binÃ¡ria (menor)
}

// ===================================================================
// Mensagens de Build
// ===================================================================

gradle.buildFinished { buildResult ->
    if (buildResult.failure) {
        println "âŒ Build falhou! Verifique os erros acima."
    } else {
        println "âœ… Build executado com sucesso!"
        println "ğŸ“¦ JAR gerado: ${jar.archiveFile.get()}"
        println "ğŸš€ Execute com: ./gradlew run"
    }
}